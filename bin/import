#!/usr/bin/env php
<?php
require 'main.php';
use EmailBundle\Model\EmailTemplate;
$bundleClasses = array('MemberBundle', 'UserBundle');
foreach($bundleClasses as $bundleClass) {
    // email template 的路徑在 bundleName/Templates/email/
    $bundle = kernel()->bundle( $bundleClass );
    $folderPath = $bundle->locate() . DIRECTORY_SEPARATOR . 'Templates' . DIRECTORY_SEPARATOR . 'email' . DIRECTORY_SEPARATOR;

    foreach (new DirectoryIterator($folderPath) as $fileInfo) {
        if ($fileInfo->isDot()) {
            continue;
        }

        if( ! $fileInfo->isDir()) {
            continue;
        }

        // 再根據 I18N 逐一載入
        $lang = $fileInfo->getFilename();
        foreach (new DirectoryIterator($fileInfo->getPathname()) as $subFileInfo) {
            if ($subFileInfo->isDot()) {
                continue;
            }

            $handle = $subFileInfo->getBasename('.html');
            $content = file_get_contents($subFileInfo->getPathname());

            // parse title from content
            $title = null;
            if ( preg_match('/^{#\s+title:\s*"(.*?)"\s*#}/is',$content, $regs) ) {
                $title = $regs[1];
            }

            $record = new EmailTemplate;
            $ret = $record->loadOrCreate([
                'title'   => $title,
                'content' => $content,
                'handle'  => $handle,
                'lang'    => $lang
                ], array('handle', 'lang'));

            echo implode('-', array($bundleClass, $lang, $handle, $ret->id ? "created" : "exists.")) . "\n";
        }
    }
}

