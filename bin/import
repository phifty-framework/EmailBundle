#!/usr/bin/env php
<?php
require 'main.php';
use EmailBundle\Model\EmailTemplate;
$bundleClasses = array('MemberBundle', 'UserBundle');
foreach($bundleClasses as $bundleClass) {
    // email template 的路徑在 bundleName/Templates/email/
    $bundle = kernel()->bundle( $bundleClass );
    $folderPath = $bundle->locate() . DIRECTORY_SEPARATOR . 'Templates' . DIRECTORY_SEPARATOR . 'email' . DIRECTORY_SEPARATOR;

    foreach (new DirectoryIterator($folderPath) as $fileInfo) {
        if ($fileInfo->isDot()) {
            continue;
        }

        if( ! $fileInfo->isDir()) {
            continue;
        }

        // 再根據 I18N 逐一載入
        $lang = $fileInfo->getFilename();
        foreach (new DirectoryIterator($fileInfo->getPathname()) as $subFileInfo) {
            if ($subFileInfo->isDot()) {
                continue;
            }

            $handle = $subFileInfo->getBasename('.html');
            $content = file_get_contents($subFileInfo->getPathname());

            // parse title from content
            $title = null;
            $comment = "Imported from " . $subFileInfo->getBasename();

            // parse annotation block...
            if ( preg_match('/^{#\s+(.*?)\s*#}/is', $content, $matches) ) {
                $annotations = $matches[1];
                if ( preg_match('/title:\s*"(.*?)"/is', $annotations, $matches) ) {
                    $title = $matches[1];
                }
                if ( preg_match('/comment:\s*"(.*?)"/is', $annotations, $matches) ) {
                    $comment = $matches[1];
                }
            }


            $record = new EmailTemplate;
            $record->createOrUpdate([
                'title'   => $title,
                'content' => $content,
                'handle'  => $handle,
                'comment' => $comment,
                'lang'    => $lang
                ], array('handle', 'lang'));

            printf("Importing %s: % -20s - %s\n",
                $bundleClass,
                $title ? "$title ($handle)" : $handle,
                $lang
            );
        }
    }
}
echo "Done\n";

